---
title: Redis核心技术10-GEO
date: 2023-03-31 12:48:27
permalink: /pages/eddb23/
categories: 
  - Redis
tags: 
  - Redis
---
## Redis核心技术10-GEO

业务场景：微信的相互定位、附件的美食、打车软件等，这些都离不开基于位置信息服务（Location-Based Service，LBS）的应用。LBS 应用访问的数据是和人或物关联的一组经纬度信息，而且要能查询相邻的经纬度范围，GEO 就非常适合应用在 LBS 服务的场景中。

## GEO底层结构

下面以叫车服务为例，来分析一下LBS应用中经纬度的存取特点。

- 每一辆网约车都有一个编号（例如 33），网约车需要将自己的经度信息（例如 116.034579）和纬度信息（例如 39.000452 ）发给叫车应用。
- 用户在叫车的时候，叫车应用会根据用户的经纬度位置（例如经度 116.054579，纬度 39.030452），查找用户的附近车辆，并进行匹配。
- 等把位置相近的用户和车辆匹配上以后，叫车应用就会根据车辆的编号，获取车辆的信息，并返回给用户。

如果我们要实现打车的基础业务，我们需要把一系列车放到一个集合里面，然后根据用户的定位和车的定位，筛选出间隔距离在规定范围内的车，然后按照一定的权重通知某一辆汽车前往用户的位置。

Hash 集合类型可以快速存取一系列的 key 和 value，正好可以用来记录一系列车辆 ID 和经纬度的对应关系，所以，我们可以把不同车辆的 ID 和它们对应的经纬度信息存在 Hash 集合中，如下图所示：

![image-20220812093842307](https://blog-1300853183.cos.ap-chengdu.myqcloud.com/img/image-20220812093842307.png)

但是这个对于LBS应用来说存在一个问题：需要根据用户的经纬度信息在车辆的 Hash 集合中进行范围查询。一旦涉及到范围查询，就意味着集合中的元素需要有序，但 Hash 类型的元素是无序的，显然不能满足我们的要求。

Sorted Set 类型也支持一个 key 对应一个 value 的记录模式，其中，key 就是 Sorted Set 中的元素，而 value 则是元素的权重分数。更重要的是，Sorted Set 可以根据元素的权重分数排序，支持范围查询。
![image-20220812094031946](https://blog-1300853183.cos.ap-chengdu.myqcloud.com/img/image-20220812094031946.png)

Sorted Set 元素的权重分数是一个浮点数（float 类型），而一组经纬度包含的是经度和纬度两个值，是没法直接保存为一个浮点数的，那么这么去保存经度和纬度呢？这时候我们就引入GeoHash编码。

## GeoHash的编码方法

GeoHash的基本原理就是`二分区间，区间编码`。当我们要对一组经纬度进行 GeoHash 编码时，我们要先对经度和纬度分别编码，然后再把经纬度各自的编码组合成一个最终编码。

对于一个地理位置信息来说，它的经度范围是[-180,180]。GeoHash 编码会把一个经度值编码成一个 N 位的二进制值，我们来对经度范围[-180,180]做 N 次的二分区操作，其中 N 可以自定义。

在进行第一次二分区时，经度范围[-180,180]会被分成两个子区间：[-180,0) 和[0,180]（我称之为左、右分区）。此时，我们可以查看一下要编码的经度值落在了左分区还是右分区。如果是落在左分区，我们就用 0 表示；如果落在右分区，就用 1 表示。这样一来，每做完一次二分区，我们就可以得到 1 位编码值。

然后，我们再对经度值所属的分区再做一次二分区，同时再次查看经度值落在了二分区后的左分区还是右分区，按照刚才的规则再做 1 位编码。当做完 N 次的二分区后，经度值就可以用一个 N bit 的数来表示了。

下面是经度(-180,180)和维度(-90,90)的编码过程：

![image-20220812094900993](https://blog-1300853183.cos.ap-chengdu.myqcloud.com/img/image-20220812094900993.png)

![image-20220812094911061](https://blog-1300853183.cos.ap-chengdu.myqcloud.com/img/image-20220812094911061.png)

当一组经纬度值都编完码后，我们再把它们的各自编码值组合在一起，组合的规则是：最终编码值的偶数位上依次是经度的编码值，奇数位上依次是纬度的编码值，其中，偶数位从 0 开始，奇数位从 1 开始。

![image-20220812095258487](https://blog-1300853183.cos.ap-chengdu.myqcloud.com/img/image-20220812095258487.png)

利用了GeoHash编码后，原来无法用一个权重分数表示的一组经纬度（116.37，39.86）就可以用 1110011101 这一个值来表示，就可以保存为 Sorted Set 的权重分数了。

其实使用了GeoHash编码后，我们相当于把整个地理空间划分成了一个个方格，每个放个对应GeoHash中的一个分区。

![image-20220812095646486](https://blog-1300853183.cos.ap-chengdu.myqcloud.com/img/image-20220812095646486.png)

## 如何操作GEO类型

- GEOADD 命令：用于把一组经纬度信息和相对应的一个 ID 记录到 GEO 类型集合中；

- GEORADIUS 命令：会根据输入的经纬度位置，查找以这个经纬度为中心的一定范围内的其他元素。当然，我们可以自己定义这个范围。

假设车辆 ID 是 33，经纬度位置是（116.034579，39.030452），我们可以用一个 GEO 集合保存所有车辆的经纬度，集合 key 是 cars:locations。执行下面的这个命令，就可以把 ID 号为 33 的车辆的当前经纬度位置存入 GEO 集合中：

```

GEOADD cars:locations 116.034579 39.030452 33
```

假设用户的经纬度是（116.054579，39.030452），现在要查找用户为中心的5公里内的车辆信息，并返回给LBS应用。

```

GEORADIUS cars:locations 116.054579 39.030452 5 km ASC COUNT 10
```

## 参考

[Redis核心技术与实战](https://time.geekbang.org/column/intro/100056701?tab=catalog)